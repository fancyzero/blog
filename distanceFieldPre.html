<head>

</head>
<script lang="javascript">
    mapSize = 128
    gridSize = 5
    
    ctxScale = 1;
    mapData = []
    intialMapData = []

    class Point
    {
        constructor(index, row, col)
        {
            this.idx = index;
            this.siteRow = row;
            this.siteCol = col;
        }

    }
    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function InitializeMap() {

        mapData = [];
        for (row = 0; row < mapSize; row++) {
            mapData[row] = []
            for (col = 0; col < mapSize; col++) {
                mapData[row][col] = new Point(0,-1,-1)
                if (getRandomInt(0,mapSize*mapSize) < 30)
                    mapData[row][col] =new Point(getRandomInt(1,6),row, col);
            }
        }
        intialMapData = CloneMap(mapData);
    }
    InitializeMap();
    var rgbToHex = function (rgb) {
        var hex = Number(rgb).toString(16);
        if (hex.length < 2) {
            hex = "0" + hex;
        }
        return hex;
    };
    var fullColorHex = function (r, g, b) {
        var red = rgbToHex(r);
        var green = rgbToHex(g);
        var blue = rgbToHex(b);
        return "#" + red + green + blue;
    };
    function ColorFromIndex(idx, highlight = false) {
        m = 1;
        if (highlight)
        m = 2;
        if (idx == 0)
            return fullColorHex(122, 122, 122)
        if (idx == 1)
            return fullColorHex(127*m, 56*m, 56*m)
        if (idx == 2)
            return fullColorHex(56*m, 127*m, 56*m)
        if (idx == 3)
            return fullColorHex(56*m, 56*m, 127*m)
        if (idx == 4)
            return fullColorHex(127*m, 127*m, 56*m)
        if (idx == 5)
            return fullColorHex(56*m, 127*m, 127*m)
        if (idx == 6)
            return fullColorHex(127*m, 56*m, 127*m)
    }
    function GetData(datas, row, col) {
        if (row >= 0 && row < mapSize && col >= 0 && col < mapSize) {
            return datas[row][col];
        }
        else
            return new Point(0,-1,-1);
    }

    function CloneMap(src) {
        newData = []
        for (y = 0; y < src.length; y++) {
            newData[y] = src[y].slice(0);
        }
        return newData;
    }
    function FloodMap(datas) {

        dest = CloneMap(datas)
        offsets = [[-1, -1], [0, -1], [1, -1],
        [-1, 0], [1, 0],/*[0,0] self*/
        [-1, 1], [0, 1], [1, 1]];
        for (row = 0; row < mapSize; row++) {
            for (col = 0; col < mapSize; col++) {
                // if (datas[row][col][0] > 0)
                //     continue;
                offsets.forEach(elm => {
                    value = GetData(datas, row + elm[0], col + elm[1]);
                    if (value.idx > 0)
                    {
                        if ( dest[row][col].idx == 0)
                        {
                            dest[row][col] = value
                        }
                        else
                        {
                            //compare distance
                            origin = [ dest[row][col].siteRow, dest[row][col].siteCol];
                            newOrigin = [ value.siteRow, value.siteCol];
                            dist2Origin= (row - origin[0])*(row - origin[0]) +(col-origin[1])*(col-origin[1]);
                            dist2NewsOrigin= (row - newOrigin[0])*(row - newOrigin[0]) +(col-newOrigin[1])*(col-newOrigin[1]);
                            if ( dist2Origin > dist2NewsOrigin)
                                dest[row][col] = value
                        }
                    }

                });

            }
        }
        mapData = dest;
        DrawMap(mapData);
    }
    function DrawMap(datas) {

        var canvas = document.getElementById('canvas');

        if (canvas.getContext) {

            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 10000, 10000);

            for (i = 0; i < mapSize; i++) {
                for (j = 0; j < mapSize; j++) {
                    if (datas[j][i].idx >= 1)
                        ctx.fillStyle = ColorFromIndex(datas[j][i].idx)
                    else
                        ctx.fillStyle = fullColorHex(125, 125, 125);
                    ctx.fillRect(i * (gridSize), j * (gridSize), gridSize, gridSize);
                    ctx.strokeStyle = "#3f3f3f";
                    ctx.strokeRect(i * (gridSize), j * (gridSize), gridSize, gridSize);
                }

            }
            for (i = 0; i < mapSize; i++) {
                for (j = 0; j < mapSize; j++) {
                    if (intialMapData[j][i].idx >= 1)
                    {
                    ctx.fillStyle = ColorFromIndex(intialMapData[j][i].idx,true);
                    ctx.fillRect(i * (gridSize), j * (gridSize), gridSize, gridSize);
                    ctx.strokeStyle = "#3f3f3f";
                    ctx.strokeRect(i * (gridSize), j * (gridSize), gridSize, gridSize);
  
                    }
                }
            }
        }
    }

    function OnCanvasMouseScroll(e) {
        var canvas = document.getElementById('canvas');

        var ctx = canvas.getContext('2d');
        var e = window.event || e;
        var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
        var oldScale = ctxScale;
        ctxScale += delta;
        if (ctxScale < 1)
            ctxScale = 1;
        if (ctxScale > 5)
            ctxScale = 5;
        console.debug(ctxScale);
        canvas.width = ctxScale * mapSize * gridSize;
        canvas.height = ctxScale * mapSize * gridSize;
        ctx.transform(ctxScale, 0, 0, ctxScale, 0, 0);

        DrawMap(mapData);

        event.preventDefault()

    }



    function OnCanvasClick(e) {
        
        var canvas = document.getElementById('canvas');
        
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        gridX= Math.floor(x/gridSize/ctxScale)
        gridY= Math.floor(y/gridSize/ctxScale)
        startX = (gridX+0.5)*gridSize;
        startY = (gridY+0.5)*gridSize;
        DrawMap(mapData);
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ctx.strokeStyle = "#ff7fff";
        closest=[]
        for (i = 0; i < mapSize; i++) {
                for (j = 0; j < mapSize; j++) {
                    if (intialMapData[j][i].idx >= 1)
                    closest.push(intialMapData[j][i])
                }
            }        
        
        closest.sort(function(a, b){
            
            endXa = (a.siteCol+0.5)*gridSize;
            endYa = (a.siteRow+0.5)*gridSize;
            endXb = (b.siteCol+0.5)*gridSize;
            endYb = (b.siteRow+0.5)*gridSize;
            distToA =  (startX - endXa)*(startX - endXa) + (startY-endYa)*(startY-endYa)
            distToB =  (startX - endXb)*(startX - endXb) + (startY-endYb)*(startY-endYb)
            return distToA - distToB;
        });
        closest = closest.slice(0,3)
        closest.forEach( pt =>
            {
                        ctx.beginPath();
                       
                        endX = (pt.siteCol+0.5)*gridSize;
                        endY = (pt.siteRow+0.5)*gridSize;
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX,endY);
                        ctx.stroke();    
                        ctx.font = "10px";
                        distance = (startX - endX)*(startX - endX) + (startY-endY)*(startY-endY)
                        distance = Math.sqrt(distance);
                        ctx.fillText(distance.toFixed(3), endX, endY);                      
                    })
    }

    function OnMapSizeChanged(e)
    {
        slider = document.getElementById("myRange");
        var output = document.getElementById("mapSize");
        output.innerHTML = slider.value;

        mapSize = slider.value
        InitializeMap();
        DrawMap(mapData);
    }

    
</script>
<html>
        
    <table>
            <tr>
                    
                <td><button onclick="FloodMap(mapData)">Flood</button>  
                    <input  type="range" min="1" max="128" value="64" class="slider" id="myRange" oninput="OnMapSizeChanged()">MapSize: <span id="mapSize">64</span>
                <button onclick="DrawMap(mapData)">Repaint</button>
                <slider ></slider>
            </td>
            </tr>
            <tr><td><canvas id="canvas" width="160" height="160"></canvas></td></tr>

</table>
<script>
    var canvas = document.getElementById('canvas');
    canvas.addEventListener("mousewheel", OnCanvasMouseScroll);
    canvas.addEventListener("mousedown", OnCanvasClick);
    canvas.width = ctxScale*mapSize*gridSize;
    canvas.height = ctxScale*mapSize*gridSize;
    DrawMap(mapData)</script>

</html>